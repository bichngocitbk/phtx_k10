<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hán Cổ — Học Từ Vựng</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="../style_learn_vocab.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<a href="../" class="home-btn"><img src="../icons/home.svg" alt="Home" width="20" height="20"><span class="btn-text"> Home</span></a>
<button class="btn-shuffle toggle-btn" onclick="shuffleAndRender()"><img src="../icons/shuffle.svg" alt="Xáo trộn" width="20" height="20"><span class="btn-text"> Xáo trộn</span></button>
<div class="container">
    <!-- HEADER -->
    <div class="header">
        <img src="../image/banner_hanco.png" alt="Hán Cổ Banner" class="banner-img"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="banner-img-fallback"></div>
            <div class="banner-overlay">
			<h1 class="title-han">學 詞 彙</h1>
		</div>
		<div class="subtitle">Học Từ Vựng Hán Cổ</div>
    </div>

    <!-- CONTROLS -->
    <div class="nav-buttons">
        <a href="hanco03_vocab_learn01.html" class="nav-btn-collect">Bộ 1</a>
        <a href="hanco03_vocab_learn02.html" class="nav-btn-collect">Bộ 2</a>
        <a href="hanco03_vocab_learn03.html" class="nav-btn-collect">Bộ 3</a>
        <a href="hanco03_vocab_learn04.html" class="nav-btn-collect">Bộ 4</a>
        <a href="hanco03_vocab_learn05.html" class="nav-btn-collect">Bộ 5</a>
        <a href="hanco03_vocab_learn06.html" class="nav-btn-collected">Bộ 6</a>
        <a href="hanco03_vocab_learn07.html" class="nav-btn-collect">Bộ 7</a>
        <a href="hanco03_vocab_learn08.html" class="nav-btn-collect">Bộ 8</a>
        <span class="stats-badge" id="statsBadge">Đang tải...</span>
    </div>
    

    <!-- COLUMN HEADERS -->
    <div class="col-headers" id="colHeaders"></div>

    <!-- VOCAB GRID -->
    <div class="vocab-grid" id="vocabGrid">
        <div class="loading-state" id="loadingState">
            <div class="spinner"></div>
            <div>Đang tải dữ liệu từ Google Sheets...</div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer-note">
        Click vào ô Hán Việt để ẩn/hiện • Nhấn <strong>Ẩn tất cả</strong> để bắt đầu tự kiểm tra
    </div>
</div>
<button class="toggle-btn hide-all-btn" onclick="hideAll()"><img src="../icons/eye-closed.svg" alt="Hide All" width="20" height="20"><span class="btn-text"> Hide All</span></button>
<button class="toggle-btn show-all-btn" onclick="revealAll()"><img src="../icons/eye.svg" alt="Show All" width="20" height="20"><span class="btn-text"> Show All</span></button>
    
<script>
    // ============================================================
    // CẤU HÌNH — Thay đổi các giá trị XXX bên dưới
    // ============================================================
    const SPREADSHEET_ID = "1eO-Wwh0RG9qgSBFJZx6CB_6Vl44PAlApk-DB6VFzthw";
    const API_KEY = atob("WUNnQUMwdHVqMnZSS0Fzdks5dGQzaFdkYnMtQzcwS1RBeVNheklB").split("").reverse().join("");
    const SHEET_NAME = "GK3006";

    const range = `${SHEET_NAME}!B1:C`;
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}`;

    // ============================================================
    // STATE
    // ============================================================
    let allData = [];       // [{han, hv}, ...]
    let displayData = [];   // shuffled copy
    const NUM_COLS = 3;     // 3 pairs of columns

    // ============================================================
    // FETCH DATA
    // ============================================================
    async function fetchData() {
        try {
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const json = await resp.json();
            const rows = json.values || [];

            allData = rows
                .filter(r => r[0] && r[1])
                .map(r => ({ han: r[0].trim(), hv: r[1].trim() }));

            if (allData.length === 0) throw new Error("Không có dữ liệu");

            displayData = [...allData];
            render();
            updateStats();
        } catch (err) {
            document.getElementById('vocabGrid').innerHTML =
                `<div class="error-state" style="grid-column:1/-1;">
                    <strong>⚠ Lỗi tải dữ liệu</strong><br>
                    ${err.message}<br><br>
                    <small>Kiểm tra SPREADSHEET_ID, API_KEY, SHEET_NAME trong mã nguồn.</small>
                </div>`;
        }
    }

    // ============================================================
    // RENDER
    // ============================================================
    function render() {
        const headerEl = document.getElementById('colHeaders');
        const gridEl = document.getElementById('vocabGrid');

        // Build headers
        let headersHTML = '';
        for (let c = 0; c < NUM_COLS; c++) {
            headersHTML += `
                <div class="col-pair-header">
                    <span>漢字</span>
                    <span>Hán Việt</span>
                </div>`;
        }
        headerEl.innerHTML = headersHTML;

        // Split data into columns
        const totalRows = displayData.length;
        const rowsPerCol = Math.ceil(totalRows / NUM_COLS);

        const columns = [];
        for (let c = 0; c < NUM_COLS; c++) {
            const start = c * rowsPerCol;
            const end = Math.min(start + rowsPerCol, totalRows);
            columns.push(displayData.slice(start, end));
        }

        // Build grid
        let gridHTML = '';
        for (let c = 0; c < NUM_COLS; c++) {
            gridHTML += '<div class="vocab-column">';
            const colData = columns[c] || [];
            colData.forEach((item, i) => {
                const globalIdx = c * rowsPerCol + i + 1;
                gridHTML += `
                    <div class="vocab-row" id="row-${globalIdx}">
                        <div class="cell-han">
                            <span class="row-idx">${globalIdx}</span>${item.han}
                        </div>
                        <div class="cell-hv hidden"
                             onclick="toggleCell(this)"
                             data-text="${escapeAttr(item.hv)}">
                            ${item.hv}
                        </div>
                    </div>`;
            });
            gridHTML += '</div>';
        }

        gridEl.innerHTML = gridHTML;
    }

    // ============================================================
    // INTERACTIONS
    // ============================================================
    function toggleCell(el) {
        el.classList.toggle('hidden');
        el.classList.toggle('revealed');
        updateStats();
    }

    function revealAll() {
        document.querySelectorAll('.cell-hv').forEach(el => {
            el.classList.remove('hidden');
            el.classList.add('revealed');
        });
        updateStats();
    }

    function hideAll() {
        document.querySelectorAll('.cell-hv').forEach(el => {
            el.classList.add('hidden');
            el.classList.remove('revealed');
        });
        updateStats();
    }

    function shuffleAndRender() {
        displayData = [...allData];
        // Fisher-Yates shuffle
        for (let i = displayData.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [displayData[i], displayData[j]] = [displayData[j], displayData[i]];
        }
        render();
        updateStats();
    }

    function updateStats() {
        const total = document.querySelectorAll('.cell-hv').length;
        const revealed = document.querySelectorAll('.cell-hv.revealed').length;
        const hidden = total - revealed;
        document.getElementById('statsBadge').innerHTML =
            `Tổng: <strong>${total}</strong> &nbsp;|&nbsp; Đã hiện: <strong>${revealed}</strong> &nbsp;|&nbsp; Đang ẩn: <strong>${hidden}</strong>`;
    }

    // ============================================================
    // UTILS
    // ============================================================
    function escapeAttr(str) {
        return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // ============================================================
    // INIT
    // ============================================================
    fetchData();
</script>

</body>
</html>
